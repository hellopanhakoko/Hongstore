<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF Topup | Scan to Pay</title>
<link rel="stylesheet" href="{{ url_for('static', filename='qrcode.css') }}">
</head>
<body>

<div class="payment-card">

    <!-- HEADER -->
    <div class="card-header">
        <h2>Scan to Pay</h2>
        <span>KHQR • Bakong Payment</span>
    </div>

    <!-- BODY -->
    <div class="card-body">

        <div class="info-box">
            <p><b>Player UID:</b> {{ player_uid }}</p>
            <p><b>Item:</b> {{ item.name }}</p>
            <p><b>Amount:</b> ${{ amount }}</p>
        </div>

        <div class="qr-box">
            <img src="data:image/png;base64,{{ qr_data }}" alt="QR Code">
        </div>

        <div class="status" id="status">⏳ Waiting for payment...</div>
        <div class="countdown">
            Time left: <span id="countdown">{{ timeout }}</span>s
        </div>

    </div>

    <div class="card-footer">
        Secure FF Topup • Powered by Shensi Store
    </div>

</div>

<script>
let timeLeft = {{ timeout }};
const countdownEl = document.getElementById("countdown");
const statusEl = document.getElementById("status");
let paymentCompleted = false;

// Countdown timer
const timer = setInterval(() => {
    if(paymentCompleted) return;
    timeLeft--;
    countdownEl.innerText = timeLeft;

    if(timeLeft <= 0){
        clearInterval(timer);
        statusEl.innerText = "❌ QR code expired";
        statusEl.style.color = "#dc2626"; // danger color
    }
}, 1000);

// Poll backend for payment status
const poll = setInterval(async () => {
    if(paymentCompleted) return;
    try {
        const res = await fetch("/check_payment_status?bill_number={{ md5 }}");
        const data = await res.json();

        if(data.status === "PAID"){
            clearInterval(timer);
            clearInterval(poll);
            paymentCompleted = true;
            statusEl.innerText = "✅ Payment Successful";
            statusEl.style.color = "#16a34a"; // success color
            setTimeout(()=> window.location.href="/succff", 1500);
        }

        if(data.status === "EXPIRED"){
            clearInterval(timer);
            clearInterval(poll);
            statusEl.innerText = "❌ Payment Expired";
            statusEl.style.color = "#dc2626"; // danger color
            setTimeout(()=> window.location.href="/ff_topup", 1500);
        }
    } catch(e){
        console.log("Error checking payment:", e);
    }
}, 3000); // poll every 3 seconds
</script>

</body>
</html>
